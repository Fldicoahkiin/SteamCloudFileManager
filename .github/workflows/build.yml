name: Build
on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]
permissions:
    contents: write
    pull-requests: write
env:
    CARGO_TERM_COLOR: always
jobs:
    check:
        name: Code Quality Checks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy, rustfmt
            - uses: Swatinem/rust-cache@v2
            - name: Install Linux dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxcb-shape0-dev libxcb-xfixes0-dev
            - name: Install fama
              run: curl -fsSL https://raw.githubusercontent.com/AkaraChen/fama/master/install.sh | sh
            - name: Check Rust formatting
              run: cargo fmt --all -- --check
            - name: Format other files
              run: fama "**/*.yml" "**/*.yaml" "**/*.toml" "**/*.md" "**/*.json"
            - name: Check if formatting changed files
              run: git diff --exit-code || (echo "‚ùå Files are not formatted. Run 'just fmt' locally." && exit 1)
            - name: Run Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings
            - name: Run tests
              run: cargo test --all-features
    build:
        name: Build ${{ matrix.name }}
        needs: check
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      name: Linux-x86_64
                      target: x86_64-unknown-linux-gnu
                    - os: windows-latest
                      name: Windows-x86_64
                      target: x86_64-pc-windows-msvc
                    - os: macos-latest
                      name: macOS-x86_64
                      target: x86_64-apple-darwin
                    - os: macos-latest
                      name: macOS-aarch64
                      target: aarch64-apple-darwin
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}
            - uses: Swatinem/rust-cache@v2
              with:
                  key: ${{ matrix.target }}
            - name: Install Linux dependencies
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxcb-shape0-dev libxcb-xfixes0-dev
            - name: Build
              run: cargo build --release --target ${{ matrix.target }} --locked
